dist: trusty
sudo: false

language: node_js
node_js:
  - 8

git:
  quiet: true

branches:
  only:
    - master
    - development
    - staging
    - /^v\d+\.\d+(\.\d+)?(-\S*)?$/

addons:
  apt:
    sources:
      - google-chrome
      - mysql-5.7-trusty
    packages:
      - google-chrome-stable
      - mysql-server
      - mysql-client

services:
  - mysql

cache:
  directories:
    - ./node_modules

install:
  - npm install
  - npm install coveralls

before_script:
  - cp ./config/db.cred.sample.ts ./config/db.cred.ts
  - cp ./config/database.sample.json ./config/database.json
  - sudo mysql -e "use mysql; update user set authentication_string=PASSWORD('') where User='root'; update user set plugin='mysql_native_password';FLUSH PRIVILEGES;"
  - sudo mysql_upgrade -u root
  - sudo service mysql restart
  - mysql -e 'CREATE DATABASE IF NOT EXISTS db;'

jobs:
  include:
    - stage: lint
      script:
        - npm run lint
    - stage: test
      script:
        - npm run test -- --no-watch --no-progress --browsers=ChromeHeadlessCI --code-coverage
    - stage: dev
      script:
        - npm run build:ssr
    - stage: stage
      script:
        - npm run build:ssr
    - stage: production
      script:
        - npm run build:ssr:production
    - stage: db
      script:
        - npm run db:up:travis:all
    - stage: e2e
      script:
        - npm run e2e -- --protractor-config=e2e/protractor-ci.conf.js

stages:
  - lint
  - name: dev
    if: branch = development
  - name: stage
    if: branch = staging
  - name: production
    if: branch = master
  - db
  - test
  - e2e

after_success:
  - cat ./coverage/lcov.info | ./node_modules/coveralls/bin/coveralls.js && rm -rf ./coverage
